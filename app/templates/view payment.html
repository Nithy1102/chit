<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Payment Records</title>

<style>
/* ===============================
   NAVBAR
================================= */
.navbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 20px;
    height: 64px;
    background: linear-gradient(90deg, #2E73CE, #00C693);
    color: white;
    position: fixed;
    top: 0;
    width: 100%;
    z-index: 2000;
    box-sizing: border-box;
}

.logo-section {
    display: flex;
    align-items: center;
    gap: 12px;
}

.logo {
    width: 42px;
    height: 42px;
    border-radius: 10px;
}

.brand {
    font-size: 16px;
    font-weight: 700;
    white-space: nowrap;
}

.menu-toggle {
    display: none;
    font-size: 26px;
    cursor: pointer;
}

.nav-links {
    list-style: none;
    gap: 35px;
    font-size: 16px;
    font-weight: 500;
}

/* DESKTOP */
@media (min-width: 901px) {
    .nav-links {
        display: flex;
    }
}

/* MOBILE */
@media (max-width: 900px) {
    .menu-toggle {
        display: block;
        z-index: 3000;
    }

    .nav-links {
        position: fixed;
        top: 64px;
        right: 10px;
        width: 220px;
        background: linear-gradient(180deg, #2E73CE, #00C693);
        flex-direction: column;
        gap: 16px;
        padding: 16px;
        border-radius: 12px;
        display: none;
        box-shadow: 0 10px 25px rgba(0,0,0,0.25);
        z-index: 2500;
    }

    .nav-links.show {
        display: flex;
    }
}

.nav-links li {
    cursor: pointer;
}

.nav-links li:hover {
    text-decoration: underline;
}

.logout-btn {
    background: #ff4f4f;
    color: white;
    border: none;
    padding: 10px 18px;
    border-radius: 8px;
    font-size: 15px;
    cursor: pointer;
}

/* hide desktop logout on mobile */
@media (max-width: 900px) {
    .logout-btn {
        display: none;
    }
}

/* ===============================
   PAGE
================================= */
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #f5f5f5;
    padding-top: 90px;
}

.page {
    display: flex;
    justify-content: center;
    padding: 20px;
}

.container {
    max-width: 900px;
    width: 100%;
    background: white;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 0 15px #ddd;
}

h2 {
    margin-top: 0;
    color: #0d67b5;
    text-align: center;
}

/* ===============================
   SEARCH
================================= */
.search-box {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.search-box input {
    flex: 1;
    padding: 10px;
    border: 1px solid #999;
    border-radius: 5px;
}

.search-box button {
    padding: 10px 20px;
    background: linear-gradient(135deg, #0099cc, #00c6a7);
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

/* mobile search */
@media (max-width: 600px) {
    .search-box {
        flex-direction: column;
    }
}

/* ===============================
   TABLE
================================= */
.table-wrapper {
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    min-width: 600px;
}

table th,
table td {
    border: 1px solid #ccc;
    padding: 12px;
    text-align: center;
}

table th {
    background: linear-gradient(135deg, #0099cc, #00c6a7);
    color: white;
}

.total-box {
    text-align: right;
    margin-top: 15px;
    font-size: 18px;
    font-weight: bold;
}
</style>
</head>

<body>

<!-- NAVBAR -->
<nav class="navbar">
    <div class="logo-section">
        <img src="{{ url_for('static', filename='logo.jpg') }}" class="logo">
        <h1 class="brand">RAJESH OPTICALS</h1>
    </div>

    <div class="menu-toggle" id="menuToggle">☰</div>

    <ul class="nav-links" id="navMenu">
        <li onclick="location.href='/dashboard'">Home</li>
        <li onclick="location.href='/patients'">Patient Records</li>
        <li onclick="location.href='/active'">Activity Log</li>
        <li id="adminNav" onclick="location.href='/signup'">Admin</li>
        <li id="notifyNav" onclick="location.href='/notifications'">Notifications</li>
        <li onclick="logout()">Logout</li>
    </ul>

    <button class="logout-btn" onclick="logout()">Logout</button>
</nav>

<!-- PAGE -->
<div class="page">
<div class="container">

    <h2>Payment Records</h2>

    <div class="search-box">
        <input type="text" id="searchName" placeholder="Search Patient Name">
        <button onclick="searchPatient()">Search</button>
    </div>

    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Patient Name</th>
                    <th>Branch</th>
                    <th>Date</th>
                    <th>Amount Paid</th>
                </tr>
            </thead>
            <tbody id="paymentTable"></tbody>
        </table>
    </div>

    <div class="total-box" id="totalAmount">
        Total Amount: ₹0
    </div>

</div>
</div>

<script>
/* ===============================
   NAVBAR TOGGLE
================================= */
document.addEventListener("DOMContentLoaded", () => {
    const toggleBtn = document.getElementById("menuToggle");
    const menu = document.getElementById("navMenu");

    if (toggleBtn && menu) {
        toggleBtn.addEventListener("click", () => {
            menu.classList.toggle("show");
        });
    }
});

/* ===============================
   SESSION CHECK + ROLE
================================= */
document.addEventListener("DOMContentLoaded", async () => {
    const res = await fetch("/api/check_session", { credentials: "include" });
    const data = await res.json();

    if (!data.logged_in) {
        window.location.href = "/login";
        return;
    }

    if (data.role !== "admin") {
        const adminNav = document.getElementById("adminNav");
        const notifyNav = document.getElementById("notifyNav");

        if (adminNav) adminNav.style.display = "none";
        if (notifyNav) notifyNav.style.display = "none";
    }
});

async function logout() {
    await fetch("/api/logout", {
        method: "POST",
        credentials: "include"
    });
    window.location.href = "/login";
}

/* ===============================
   PAYMENTS LOGIC
================================= */
let payments = [];

async function loadPayments(filterName = "") {
    if (!payments.length) {
        const res = await fetch("/payments-view");
        payments = await res.json();
    }

    const table = document.getElementById("paymentTable");
    table.innerHTML = "";
    let total = 0;

    payments
        .filter(p => p.name.toLowerCase().includes(filterName.toLowerCase()))
        .forEach(p => {
            total += Number(p.amount);

            table.innerHTML += `
                <tr>
                    <td>${p.name}</td>
                    <td>${p.branch || "-"}</td>
                    <td>${p.date}</td>
                    <td>₹${p.amount}</td>
                </tr>
            `;
        });

    document.getElementById("totalAmount").innerText =
        "Total Amount: ₹" + total;
}

function searchPatient() {
    loadPayments(document.getElementById("searchName").value);
}

loadPayments();
</script>

</body>
</html>
